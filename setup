#!/bin/bash

set -e

DIR=$( cd "$( dirname "$0" )" && pwd )
DOTFILES=$DIR/dotfiles

linked() {
    ln -shf "$DOTFILES/$1" "$HOME/$1"
}

dotfiles() {
    echo "Linking all dotfiles to home directory"

    linked ".irbrc"
    linked ".gitconfig"
    linked ".tmux.conf"
    linked ".tmuxinator"
    linked ".emacs.d"
    linked ".gemrc"

    linked "bin"

    mkdir -p ~/.config
    linked ".config/fish"

    mkdir -p ~/Library/Application\ Support/Code/User
    linked "Library/Application Support/Code/User/settings.json"
    linked "Library/Application Support/Code/User/keybindings.json"
    linked ".vscode/extensions/vroy-code"

    mkdir -p ~/Library/KeyBindings
    linked "Library/KeyBindings/DefaultKeyBinding.dict"
}

updateBrew() {
    set +e

    which brew
    if [ $? -ne 0 ] ; then
        echo Installing Homebrew
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi

    echo Updating Homebrew
    brew update
    brew upgrade

    # Create /usr/local/Frameworks/ required for python.
    FW="/usr/local/Frameworks"

    stat "$FW" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "[sudo] Creating $FW"
        sudo mkdir -p "$FW"
    fi

    MY_ID=$(id -u)
    FW_ID=$(stat -f "%u" "$FW")
    if [[ "$MY_ID" -ne "$FW_ID" ]]; then
        echo "[sudo] Changing ownership of $FW"
        sudo chown $(whoami):admin "$FW"
    fi
    set -e
}

brewBundle() {
    echo Installing packages from Brewfile
    brew bundle --verbose
}

iTermConfig() {
    # Specify the preferences directory
    defaults write com.googlecode.iterm2.plist PrefsCustomFolder -string "$DIR/dotfiles/iterm"

    # Tell iTerm2 to use the custom preferences in the directory
    defaults write com.googlecode.iterm2.plist LoadPrefsFromCustomFolder -bool true
}

setFishShell() {
    echo Setting shell to fish
    # Add fish to shells
    grep fish /etc/shells
    if [ $? -ne 0 ]; then
        sudo sh -c "echo /usr/local/bin/fish >> /etc/shells"
        # Change shell to fish
        chsh -s /usr/local/bin/fish
    fi
}

installGems() {
    gem install -N ruby-keychain
    gem install -N octokit
    gem install -N tmuxinator
    gem install -N aws-sdk
}

installOthers() {
    go get -u github.com/vroy/git-gb

    # terraform-index, used with the mauve.terraform extension
    set +e
    which terraform-index
    if [ $? -ne 0 ]; then
        set -e
        wget -O /tmp/terraform-index.zip https://github.com/mauve/terraform-index/releases/download/0.0.2/terraform-index-0.0.2-macos-amd64.zip
        unzip /tmp/terraform-index.zip -d /usr/local/bin
        rm /tmp/terraform-index.zip
    fi
    set -e
}

osxDefaults() {
    echo Mac OS Defaults
    ./os_x_defaults.sh
}

codePlugin() {
    code --install-extension --force $0
}

codeExtensions() {
    echo Installing VS Code Extensions

    # Editor
    codePlugin christian-kohler.path-intellisense
    codePlugin christian-kohler.npm-intellisense
    codePlugin EditorConfig.editorconfig
    codePlugin lfs.vscode-emacs-friendly
    codePlugin vscode-icons-team.vscode-icons
    codePlugin ziyasal.vscode-open-in-github

    # Languages
    codePlugin bierner.markdown-mermaid
    codePlugin bierner.markdown-preview-github-styles
    codePlugin coolbear.systemd-unit-file
    codePlugin erd0s.terraform-autocomplete
    codePlugin lunaryorn.fish-ide
    codePlugin JPTarquino.postgresql
    codePlugin ms-vscode.Go
    codePlugin mathiasfrohlich.kotlin
    codePlugin mauve.terraform
    codePlugin mikestead.dotenv
    codePlugin ms-python.python
    codePlugin naco-siren.gradle-language
    codePlugin PeterJausovec.vscode-docker
    codePlugin rebornix.ruby
    codePlugin robinbentley.sass-indented
    codePlugin secanis.jenkinsfile-support
    codePlugin skyapps.fish-vscode
    codePlugin wholroyd.jinja
    codePlugin yzhang.markdown-all-in-one

    # VueJS and JavaScript
    codePlugin dbaeumer.vscode-eslint
    codePlugin octref.vetur
    codePlugin dariofuzinato.vue-peek
}

configurePython() {
    echo "Updating pip"
    pip3 install --upgrade pip setuptools wheel

    pip3 install requests

    # For VS Code
    pip2 install pylint
}

buildBase62() {
    cd uuid-base62-converter; ./build.sh
}

dotfiles
updateBrew
brewBundle
configurePython
installGems
installOthers
iTermConfig
setFishShell
osxDefaults
codeExtensions
buildBase62
